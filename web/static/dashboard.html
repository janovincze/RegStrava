<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RegStrava</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body class="dashboard-body">
    <nav class="navbar">
        <div class="container nav-container">
            <a href="/" class="logo">
                <span class="logo-text">RegStrava</span>
            </a>
            <div class="nav-links">
                <span id="nav-funder-name" class="nav-user"></span>
                <a href="/" class="btn btn-ghost">Home</a>
                <button onclick="logout()" class="btn btn-ghost">Logout</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="#overview" class="sidebar-link active" onclick="showSection('overview')">
                    <span>I</span> Overview
                </a>
                <a href="#invoices" class="sidebar-link" onclick="showSection('invoices')">
                    <span>II</span> Invoices
                </a>
                <a href="#api-keys" class="sidebar-link" onclick="showSection('api-keys')">
                    <span>III</span> API Keys
                </a>
                <a href="#test-api" class="sidebar-link" onclick="showSection('test-api')">
                    <span>IV</span> Test API
                </a>
                <a href="#docs" class="sidebar-link" onclick="showSection('docs')">
                    <span>V</span> Documentation
                </a>
                <a href="#subscription" class="sidebar-link" onclick="showSection('subscription')">
                    <span>VI</span> Subscription
                </a>
                <a href="#settings" class="sidebar-link" onclick="showSection('settings')">
                    <span>VII</span> Settings
                </a>
            </nav>
        </aside>

        <main class="dashboard-main" id="dashboard-content">
            <!-- Overview Section -->
            <section id="section-overview" class="dashboard-section active">
                <div class="section-header">
                    <h1>Welcome back, <span id="funder-name">Funder</span></h1>
                    <p>Manage your invoice registry integration</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">01</div>
                        <div class="stat-info">
                            <span class="stat-value" id="subscription-tier">Free</span>
                            <span class="stat-label">Subscription Tier</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">02</div>
                        <div class="stat-info">
                            <span class="stat-value" id="monthly-checks-used">0</span>
                            <span class="stat-label">Monthly Checks Used</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">03</div>
                        <div class="stat-info">
                            <span class="stat-value" id="monthly-registers-used">0</span>
                            <span class="stat-label">Monthly Registers Used</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">04</div>
                        <div class="stat-info">
                            <span class="stat-value" id="account-status">Active</span>
                            <span class="stat-label">Account Status</span>
                        </div>
                    </div>
                </div>

                <!-- Usage Progress Bars -->
                <div class="usage-section" id="usage-section">
                    <h2>Current Usage</h2>
                    <div id="usage-warning" class="usage-warning" style="display: none;"></div>
                    <div class="usage-grid">
                        <div class="usage-card">
                            <div class="usage-header">
                                <span>Daily Checks</span>
                                <span id="daily-check-text">0 / 10</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="daily-check-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="usage-card">
                            <div class="usage-header">
                                <span>Daily Registers</span>
                                <span id="daily-register-text">0 / 2</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="daily-register-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="usage-card">
                            <div class="usage-header">
                                <span>Monthly Checks</span>
                                <span id="monthly-check-text">0 / 100</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="monthly-check-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="usage-card">
                            <div class="usage-header">
                                <span>Monthly Registers</span>
                                <span id="monthly-register-text">0 / 10</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="monthly-register-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <p class="usage-reset-info">
                        Daily resets at: <span id="daily-reset-time">midnight UTC</span> |
                        Monthly resets at: <span id="monthly-reset-time">1st of next month</span>
                    </p>
                </div>

                <div class="quick-start">
                    <h2>Quick Start</h2>
                    <div class="code-block">
                        <div class="code-header">
                            <span>Check if invoice is funded</span>
                            <button class="copy-btn" onclick="copyCode('check-code')">Copy</button>
                        </div>
                        <pre id="check-code">curl -X POST <span class="api-url"></span>/api/v1/invoices/check-raw \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "document_type": "INV",
    "document_id": "INV-2024-001",
    "supplier_tax_id": "123456789",
    "supplier_country": "DE",
    "buyer_tax_id": "987654321",
    "buyer_country": "AT",
    "amount": 10000.00,
    "currency": "EUR"
  }'</pre>
                    </div>
                </div>
            </section>

            <!-- Invoices Section -->
            <section id="section-invoices" class="dashboard-section">
                <div class="section-header">
                    <h1>Invoice Management</h1>
                    <p>Check and register invoices manually</p>
                </div>

                <div class="data-rules-notice">
                    <div class="notice-icon">!</div>
                    <div class="notice-content">
                        <strong>Enter data exactly as it appears on the invoice</strong>
                        <p>Even a single character difference will produce a different hash and fail to match. See the <a href="/#data-rules">Data Entry Rules</a> for detailed formatting guidelines.</p>
                    </div>
                </div>

                <div class="invoice-grid">
                    <!-- Check Invoice Card -->
                    <div class="card">
                        <h3>Check Invoice</h3>
                        <p class="text-muted">Verify if an invoice is already funded</p>
                        <form id="check-invoice-form" onsubmit="checkInvoice(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-document-id">Document ID <span class="required">*</span></label>
                                    <input type="text" id="check-document-id" required placeholder="INV-2024-001">
                                    <span class="field-hint">Exactly as printed, including hyphens and prefixes</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-document-type">Type</label>
                                    <select id="check-document-type">
                                        <option value="INV" selected>Invoice</option>
                                        <option value="CN">Credit Note</option>
                                        <option value="DN">Debit Note</option>
                                        <option value="PO">Purchase Order</option>
                                    </select>
                                    <span class="field-hint">Document type</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-supplier-tax-id">Supplier Tax ID <span class="required">*</span></label>
                                    <input type="text" id="check-supplier-tax-id" required placeholder="123456789">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-supplier-country">Country <span class="required">*</span></label>
                                    <input type="text" id="check-supplier-country" required placeholder="DE" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-buyer-tax-id">Buyer Tax ID <span class="required">*</span></label>
                                    <input type="text" id="check-buyer-tax-id" required placeholder="987654321">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-buyer-country">Country <span class="required">*</span></label>
                                    <input type="text" id="check-buyer-country" required placeholder="AT" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-amount">Amount</label>
                                    <input type="number" id="check-amount" step="0.01" placeholder="10000.00">
                                    <span class="field-hint">Gross total with decimal point</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-currency">Currency</label>
                                    <input type="text" id="check-currency" placeholder="EUR" maxlength="3" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="hash-level-info">
                                <span class="level-indicator">L0-L3</span> Checks party (L0), relationship (L1), document (L2), and full (L3) levels
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Check Invoice</button>
                        </form>
                        <div id="check-result" class="result-box"></div>
                    </div>

                    <!-- Register Invoice Card -->
                    <div class="card">
                        <h3>Register Invoice</h3>
                        <p class="text-muted">Register an invoice as funded</p>
                        <form id="register-invoice-form" onsubmit="registerInvoice(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-document-id">Document ID <span class="required">*</span></label>
                                    <input type="text" id="reg-document-id" required placeholder="INV-2024-001">
                                    <span class="field-hint">Exactly as printed, including hyphens and prefixes</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-document-type">Type</label>
                                    <select id="reg-document-type">
                                        <option value="INV" selected>Invoice</option>
                                        <option value="CN">Credit Note</option>
                                        <option value="DN">Debit Note</option>
                                        <option value="PO">Purchase Order</option>
                                    </select>
                                    <span class="field-hint">Document type</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-supplier-tax-id">Supplier Tax ID <span class="required">*</span></label>
                                    <input type="text" id="reg-supplier-tax-id" required placeholder="123456789">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-supplier-country">Country <span class="required">*</span></label>
                                    <input type="text" id="reg-supplier-country" required placeholder="DE" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-buyer-tax-id">Buyer Tax ID <span class="required">*</span></label>
                                    <input type="text" id="reg-buyer-tax-id" required placeholder="987654321">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-buyer-country">Country <span class="required">*</span></label>
                                    <input type="text" id="reg-buyer-country" required placeholder="AT" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-amount">Amount</label>
                                    <input type="number" id="reg-amount" step="0.01" placeholder="10000.00">
                                    <span class="field-hint">Gross total with decimal point</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-currency">Currency</label>
                                    <input type="text" id="reg-currency" placeholder="EUR" maxlength="3" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="reg-expires">Expires In (days)</label>
                                <input type="number" id="reg-expires" placeholder="730" value="730">
                                <span class="field-hint">How long before registration auto-expires (default: 2 years)</span>
                            </div>
                            <div class="hash-level-info">
                                <span class="level-indicator">L1-L3</span> Registers relationship (L1), document (L2), and optionally full (L3) levels
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Register Invoice</button>
                        </form>
                        <div id="register-result" class="result-box"></div>
                    </div>
                </div>
            </section>

            <!-- API Keys Section -->
            <section id="section-api-keys" class="dashboard-section">
                <div class="section-header">
                    <h1>API Keys</h1>
                    <p>Manage your API credentials</p>
                </div>

                <div class="card">
                    <h3>Current API Key</h3>
                    <p class="text-muted">Use this key in the X-API-Key header</p>
                    <div class="api-key-display">
                        <code id="current-api-key">Loading...</code>
                        <button class="btn btn-ghost" onclick="copyApiKey()">Copy</button>
                    </div>
                    <button class="btn btn-danger" onclick="regenerateApiKey()">
                        Regenerate API Key
                    </button>
                    <p class="warning-text">Regenerating will invalidate your current key immediately.</p>
                </div>

                <div class="card">
                    <h3>OAuth 2.0 Credentials</h3>
                    <p class="text-muted">For enterprise integrations using OAuth client credentials flow</p>
                    <div class="oauth-info">
                        <div class="form-group">
                            <label>Client ID</label>
                            <code id="oauth-client-id-display">Available at signup only</code>
                        </div>
                        <p class="info-text">OAuth credentials are only shown during account creation. Contact support if you need new OAuth credentials.</p>
                    </div>
                </div>
            </section>

            <!-- Test API Section -->
            <section id="section-test-api" class="dashboard-section">
                <div class="section-header">
                    <h1>Test API</h1>
                    <p>Try out the API with sample requests</p>
                </div>

                <div class="card">
                    <h3>Check Invoice Status</h3>
                    <p class="text-muted">Test the API with a sample invoice check</p>
                    <button class="btn btn-primary" onclick="testCheckInvoice()">
                        Run Test Check
                    </button>
                    <div id="test-result" class="test-result"></div>
                </div>

                <div class="card">
                    <h3>API Endpoints</h3>
                    <table class="endpoints-table">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Endpoint</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="endpoint-group">Invoice Endpoints</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/check</code></td>
                                <td>Check with pre-hashed data</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/check-raw</code></td>
                                <td>Check with raw invoice data (L0-L3)</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/register</code></td>
                                <td>Register with pre-hashed data</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/register-raw</code></td>
                                <td>Register with raw invoice data</td>
                            </tr>
                            <tr>
                                <td><span class="method delete">DELETE</span></td>
                                <td><code>/api/v1/invoices/{hash}</code></td>
                                <td>Unregister an invoice</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="endpoint-group">Party Endpoints (L0)</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/party/check</code></td>
                                <td>Check buyer/supplier existence</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/party/register</code></td>
                                <td>Register a party</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/party/history</code></td>
                                <td>Query party check history</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="endpoint-group">Reference Data</td>
                            </tr>
                            <tr>
                                <td><span class="method get">GET</span></td>
                                <td><code>/api/v1/document-types</code></td>
                                <td>List available document types</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Documentation Section -->
            <section id="section-docs" class="dashboard-section">
                <div class="section-header">
                    <h1>Documentation</h1>
                    <p>Learn how to integrate RegStrava</p>
                </div>

                <div class="docs-grid">
                    <div class="card">
                        <h3>Quick Start</h3>
                        <p>Get up and running in minutes with our step-by-step guide.</p>
                        <a href="https://github.com/janovincze/RegStrava#quick-start" target="_blank" class="btn btn-ghost">View Guide</a>
                    </div>
                    <div class="card">
                        <h3>API Reference</h3>
                        <p>Complete API documentation with examples.</p>
                        <a href="https://github.com/janovincze/RegStrava#api-usage" target="_blank" class="btn btn-ghost">View Docs</a>
                    </div>
                    <div class="card">
                        <h3>Go SDK</h3>
                        <p>Official Go SDK for client-side hashing.</p>
                        <a href="https://github.com/janovincze/RegStrava#go-sdk" target="_blank" class="btn btn-ghost">View SDK</a>
                    </div>
                    <div class="card">
                        <h3>Security</h3>
                        <p>Learn about our privacy-preserving approach.</p>
                        <a href="https://github.com/janovincze/RegStrava#security" target="_blank" class="btn btn-ghost">Learn More</a>
                    </div>
                </div>
            </section>

            <!-- Subscription Section -->
            <section id="section-subscription" class="dashboard-section">
                <div class="section-header">
                    <h1>Subscription</h1>
                    <p>Manage your subscription and view usage</p>
                </div>

                <div class="card">
                    <h3>Current Plan</h3>
                    <div class="current-plan">
                        <div class="plan-badge" id="plan-badge">Free</div>
                        <div class="plan-details">
                            <p id="plan-description">Get started with basic invoice checking</p>
                            <p class="plan-price" id="plan-price">$0/month</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Available Plans</h3>
                    <div class="plans-grid" id="plans-grid">
                        <!-- Plans loaded dynamically -->
                    </div>
                </div>

                <div class="card">
                    <h3>Usage Details</h3>
                    <div class="usage-details-grid">
                        <div class="usage-detail">
                            <h4>Daily Usage</h4>
                            <table class="usage-table">
                                <tr>
                                    <td>Checks</td>
                                    <td id="detail-daily-checks">0 / 10</td>
                                </tr>
                                <tr>
                                    <td>Registers</td>
                                    <td id="detail-daily-registers">0 / 2</td>
                                </tr>
                                <tr>
                                    <td>Resets at</td>
                                    <td id="detail-daily-reset">Midnight UTC</td>
                                </tr>
                            </table>
                        </div>
                        <div class="usage-detail">
                            <h4>Monthly Usage</h4>
                            <table class="usage-table">
                                <tr>
                                    <td>Checks</td>
                                    <td id="detail-monthly-checks">0 / 100</td>
                                </tr>
                                <tr>
                                    <td>Registers</td>
                                    <td id="detail-monthly-registers">0 / 10</td>
                                </tr>
                                <tr>
                                    <td>Resets at</td>
                                    <td id="detail-monthly-reset">1st of next month</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Features by Plan</h3>
                    <table class="features-table">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Free</th>
                                <th>Basic</th>
                                <th>Premium</th>
                                <th>Enterprise</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Daily Checks</td>
                                <td>10</td>
                                <td>100</td>
                                <td>500</td>
                                <td>Unlimited</td>
                            </tr>
                            <tr>
                                <td>Monthly Checks</td>
                                <td>100</td>
                                <td>1,000</td>
                                <td>10,000</td>
                                <td>Unlimited</td>
                            </tr>
                            <tr>
                                <td>Daily Registers</td>
                                <td>2</td>
                                <td>20</td>
                                <td>100</td>
                                <td>Unlimited</td>
                            </tr>
                            <tr>
                                <td>Monthly Registers</td>
                                <td>10</td>
                                <td>100</td>
                                <td>1,000</td>
                                <td>Unlimited</td>
                            </tr>
                            <tr>
                                <td>Email Notifications</td>
                                <td>-</td>
                                <td>Yes</td>
                                <td>Yes</td>
                                <td>Yes</td>
                            </tr>
                            <tr>
                                <td>Webhook Notifications</td>
                                <td>-</td>
                                <td>-</td>
                                <td>Yes</td>
                                <td>Yes</td>
                            </tr>
                            <tr>
                                <td>Priority Support</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td>Yes</td>
                            </tr>
                            <tr>
                                <td>Price</td>
                                <td>$0</td>
                                <td>$29/mo</td>
                                <td>$99/mo</td>
                                <td>Contact</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="dashboard-section">
                <div class="section-header">
                    <h1>Settings</h1>
                    <p>Manage your account settings</p>
                </div>

                <div class="card">
                    <h3>Profile Information</h3>
                    <form id="profile-form" onsubmit="updateProfile(event)">
                        <div class="form-group">
                            <label for="profile-name">Name</label>
                            <input type="text" id="profile-name" name="name">
                        </div>
                        <div class="form-group">
                            <label>Funder ID</label>
                            <code id="funder-id">Loading...</code>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Funder Tracking</h3>
                    <p class="text-muted">Allow tracking of your funding registrations for audit purposes.</p>
                    <div class="toggle-group">
                        <label class="toggle">
                            <input type="checkbox" id="tracking-toggle" onchange="updateTracking()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span>Enable funder tracking</span>
                    </div>
                </div>

                <div class="card danger-zone">
                    <h3>Danger Zone</h3>
                    <p class="text-muted">Irreversible actions</p>
                    <button class="btn btn-danger" onclick="logout()">
                        Logout from all devices
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Set API URL in examples
            document.querySelectorAll('.api-url').forEach(el => {
                el.textContent = window.location.origin;
            });

            // Load funder name from storage
            const funderName = localStorage.getItem('regstrava_funder_name');
            if (funderName) {
                document.getElementById('nav-funder-name').textContent = funderName;
            }

            // Load API key preview
            const apiKey = localStorage.getItem('regstrava_api_key');
            if (apiKey) {
                document.getElementById('current-api-key').textContent = apiKey.substring(0, 20) + '...';
            }

            // Load dashboard data
            loadDashboard();

            // Load usage data
            loadUsageData();

            // Load subscription tiers
            loadSubscriptionTiers();
        });

        // Load usage data
        async function loadUsageData() {
            const apiKey = localStorage.getItem('regstrava_api_key');
            if (!apiKey) return;

            try {
                const response = await fetch('/api/v1/funders/me/usage', {
                    headers: { 'X-API-Key': apiKey }
                });

                if (!response.ok) return;

                const data = await response.json();
                const usage = data.usage;
                const subscription = data.subscription;

                // Update subscription tier display
                if (subscription && subscription.tier) {
                    document.getElementById('subscription-tier').textContent = subscription.tier.display_name || 'Free';
                    document.getElementById('plan-badge').textContent = subscription.tier.display_name || 'Free';
                    document.getElementById('plan-description').textContent = subscription.tier.description || '';
                    const price = subscription.tier.price_monthly_cents ? `$${subscription.tier.price_monthly_cents / 100}/month` : '$0/month';
                    document.getElementById('plan-price').textContent = price;
                }

                // Update usage stats
                document.getElementById('monthly-checks-used').textContent = usage.monthly_checks.toLocaleString();
                document.getElementById('monthly-registers-used').textContent = usage.monthly_registers.toLocaleString();

                // Update progress bars
                updateProgressBar('daily-check', usage.daily_checks, usage.daily_check_limit);
                updateProgressBar('daily-register', usage.daily_registers, usage.daily_register_limit);
                updateProgressBar('monthly-check', usage.monthly_checks, usage.monthly_check_limit);
                updateProgressBar('monthly-register', usage.monthly_registers, usage.monthly_register_limit);

                // Update detail texts
                document.getElementById('detail-daily-checks').textContent = formatUsage(usage.daily_checks, usage.daily_check_limit);
                document.getElementById('detail-daily-registers').textContent = formatUsage(usage.daily_registers, usage.daily_register_limit);
                document.getElementById('detail-monthly-checks').textContent = formatUsage(usage.monthly_checks, usage.monthly_check_limit);
                document.getElementById('detail-monthly-registers').textContent = formatUsage(usage.monthly_registers, usage.monthly_register_limit);

                // Update reset times
                if (usage.daily_resets_at) {
                    document.getElementById('daily-reset-time').textContent = new Date(usage.daily_resets_at).toLocaleTimeString();
                    document.getElementById('detail-daily-reset').textContent = new Date(usage.daily_resets_at).toLocaleString();
                }
                if (usage.monthly_resets_at) {
                    document.getElementById('monthly-reset-time').textContent = new Date(usage.monthly_resets_at).toLocaleDateString();
                    document.getElementById('detail-monthly-reset').textContent = new Date(usage.monthly_resets_at).toLocaleDateString();
                }

                // Show warning if needed
                if (data.warning_level) {
                    const warningDiv = document.getElementById('usage-warning');
                    warningDiv.style.display = 'block';
                    warningDiv.className = 'usage-warning ' + (data.warning_level === 'critical' ? 'critical' : 'warning');
                    warningDiv.textContent = data.warning_message;
                }

            } catch (error) {
                console.error('Error loading usage data:', error);
            }
        }

        function updateProgressBar(id, used, limit) {
            const progress = document.getElementById(id + '-progress');
            const text = document.getElementById(id + '-text');

            if (!limit) {
                // Unlimited
                progress.style.width = '5%';
                progress.classList.remove('warning', 'critical');
                text.textContent = used + ' / Unlimited';
                return;
            }

            const percent = Math.min((used / limit) * 100, 100);
            progress.style.width = percent + '%';
            text.textContent = used + ' / ' + limit;

            // Color based on percentage
            progress.classList.remove('warning', 'critical');
            if (percent >= 90) {
                progress.classList.add('critical');
            } else if (percent >= 80) {
                progress.classList.add('warning');
            }
        }

        function formatUsage(used, limit) {
            if (!limit) return used + ' / Unlimited';
            return used + ' / ' + limit;
        }

        // Load subscription tiers
        async function loadSubscriptionTiers() {
            try {
                const response = await fetch('/api/v1/subscription-tiers');
                if (!response.ok) return;

                const data = await response.json();
                const plansGrid = document.getElementById('plans-grid');

                if (data.tiers && data.tiers.length > 0) {
                    plansGrid.innerHTML = data.tiers.map(tier => `
                        <div class="plan-card ${tier.name}">
                            <h4>${tier.display_name}</h4>
                            <p class="plan-desc">${tier.description}</p>
                            <p class="plan-price">${tier.price_monthly_cents ? '$' + (tier.price_monthly_cents / 100) + '/mo' : 'Free'}</p>
                            <ul class="plan-features">
                                <li>${tier.check_limit_monthly ? tier.check_limit_monthly + ' checks/mo' : 'Unlimited checks'}</li>
                                <li>${tier.register_limit_monthly ? tier.register_limit_monthly + ' registers/mo' : 'Unlimited registers'}</li>
                                ${tier.notification_email ? '<li>Email notifications</li>' : ''}
                                ${tier.notification_webhook ? '<li>Webhook notifications</li>' : ''}
                            </ul>
                            ${tier.name !== 'free' ? '<button class="btn btn-primary btn-small" onclick="requestUpgrade(\'' + tier.name + '\')">Upgrade</button>' : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading subscription tiers:', error);
            }
        }

        async function requestUpgrade(tierName) {
            const apiKey = localStorage.getItem('regstrava_api_key');
            try {
                const response = await fetch('/api/v1/funders/me/subscription/upgrade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ tier_name: tierName })
                });

                const result = await response.json();
                alert(result.message);
            } catch (error) {
                alert('Error requesting upgrade');
            }
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active from all links
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById('section-' + sectionId).classList.add('active');

            // Mark link as active
            event.target.closest('.sidebar-link').classList.add('active');
        }

        function copyCode(elementId) {
            const code = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(code);
        }

        function copyApiKey() {
            const apiKey = localStorage.getItem('regstrava_api_key');
            navigator.clipboard.writeText(apiKey).then(() => {
                alert('API Key copied to clipboard!');
            });
        }

        async function updateProfile(e) {
            e.preventDefault();
            const apiKey = localStorage.getItem('regstrava_api_key');
            const name = document.getElementById('profile-name').value;

            try {
                const response = await fetch('/api/v1/funders/me', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    localStorage.setItem('regstrava_funder_name', name);
                    document.getElementById('funder-name').textContent = name;
                    document.getElementById('nav-funder-name').textContent = name;
                    alert('Profile updated!');
                }
            } catch (error) {
                alert('Error updating profile');
            }
        }

        async function updateTracking() {
            const apiKey = localStorage.getItem('regstrava_api_key');
            const tracking = document.getElementById('tracking-toggle').checked;

            try {
                await fetch('/api/v1/funders/me', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ track_fundings: tracking })
                });
            } catch (error) {
                alert('Error updating tracking settings');
            }
        }

        // Check Invoice
        async function checkInvoice(e) {
            e.preventDefault();
            const apiKey = localStorage.getItem('regstrava_api_key');
            const resultDiv = document.getElementById('check-result');

            const data = {
                document_type: document.getElementById('check-document-type').value,
                document_id: document.getElementById('check-document-id').value,
                supplier_tax_id: document.getElementById('check-supplier-tax-id').value,
                supplier_country: document.getElementById('check-supplier-country').value.toUpperCase(),
                buyer_tax_id: document.getElementById('check-buyer-tax-id').value,
                buyer_country: document.getElementById('check-buyer-country').value.toUpperCase()
            };

            const amount = document.getElementById('check-amount').value;
            if (amount) data.amount = parseFloat(amount);

            const currency = document.getElementById('check-currency').value;
            if (currency) data.currency = currency.toUpperCase();

            resultDiv.innerHTML = '<div class="loading">Checking...</div>';

            try {
                const response = await fetch('/api/v1/invoices/check-raw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.found) {
                        const levels = result.matched_levels ? result.matched_levels.join(', ') : 'N/A';
                        let detailsHtml = '';
                        if (result.details) {
                            detailsHtml = Object.entries(result.details).map(([level, detail]) =>
                                `<div><span class="label">${level}:</span> ${detail.status} (${new Date(detail.first_seen).toLocaleDateString()})</div>`
                            ).join('');
                        }
                        resultDiv.innerHTML = `
                            <div class="result-funded">
                                <div class="result-icon">&#10007;</div>
                                <div class="result-title">Match Found</div>
                                <div class="result-detail">
                                    <span class="label">Matched Levels:</span> ${levels}<br>
                                    ${detailsHtml}
                                </div>
                            </div>`;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="result-clear">
                                <div class="result-icon">&#10003;</div>
                                <div class="result-title">Not Found</div>
                                <div class="result-detail">This invoice is not in the registry. Safe to fund.</div>
                            </div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="result-error">Error: ${result.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result-error">Error: ${error.message}</div>`;
            }
        }

        // Register Invoice
        async function registerInvoice(e) {
            e.preventDefault();
            const apiKey = localStorage.getItem('regstrava_api_key');
            const resultDiv = document.getElementById('register-result');

            const data = {
                document_type: document.getElementById('reg-document-type').value,
                document_id: document.getElementById('reg-document-id').value,
                supplier_tax_id: document.getElementById('reg-supplier-tax-id').value,
                supplier_country: document.getElementById('reg-supplier-country').value.toUpperCase(),
                buyer_tax_id: document.getElementById('reg-buyer-tax-id').value,
                buyer_country: document.getElementById('reg-buyer-country').value.toUpperCase(),
                funding_date: new Date().toISOString().split('T')[0]
            };

            const amount = document.getElementById('reg-amount').value;
            if (amount) data.amount = parseFloat(amount);

            const currency = document.getElementById('reg-currency').value;
            if (currency) data.currency = currency.toUpperCase();

            const expires = document.getElementById('reg-expires').value;
            if (expires) data.expires_in_days = parseInt(expires);

            resultDiv.innerHTML = '<div class="loading">Registering...</div>';

            try {
                const response = await fetch('/api/v1/invoices/register-raw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    const levels = result.hash_levels ? result.hash_levels.map(l => 'L' + l).join(', ') : 'N/A';
                    resultDiv.innerHTML = `
                        <div class="result-success">
                            <div class="result-icon">&#10003;</div>
                            <div class="result-title">Invoice Registered</div>
                            <div class="result-detail">
                                <span class="label">Hash Levels:</span> ${levels}<br>
                                <span class="label">Registered At:</span> ${new Date(result.registered_at).toLocaleDateString()}
                            </div>
                        </div>`;
                    // Clear form
                    document.getElementById('register-invoice-form').reset();
                    document.getElementById('reg-expires').value = '730';
                } else {
                    resultDiv.innerHTML = `<div class="result-error">Error: ${result.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result-error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
