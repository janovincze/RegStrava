<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RegStrava</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body class="dashboard-body">
    <nav class="navbar">
        <div class="container nav-container">
            <a href="/" class="logo">
                <span class="logo-text">RegStrava</span>
            </a>
            <div class="nav-links">
                <span id="nav-funder-name" class="nav-user"></span>
                <a href="/" class="btn btn-ghost">Home</a>
                <button onclick="logout()" class="btn btn-ghost">Logout</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="#overview" class="sidebar-link active" onclick="showSection('overview')">
                    <span>I</span> Overview
                </a>
                <a href="#invoices" class="sidebar-link" onclick="showSection('invoices')">
                    <span>II</span> Invoices
                </a>
                <a href="#api-keys" class="sidebar-link" onclick="showSection('api-keys')">
                    <span>III</span> API Keys
                </a>
                <a href="#test-api" class="sidebar-link" onclick="showSection('test-api')">
                    <span>IV</span> Test API
                </a>
                <a href="#docs" class="sidebar-link" onclick="showSection('docs')">
                    <span>V</span> Documentation
                </a>
                <a href="#settings" class="sidebar-link" onclick="showSection('settings')">
                    <span>VI</span> Settings
                </a>
            </nav>
        </aside>

        <main class="dashboard-main" id="dashboard-content">
            <!-- Overview Section -->
            <section id="section-overview" class="dashboard-section active">
                <div class="section-header">
                    <h1>Welcome back, <span id="funder-name">Funder</span></h1>
                    <p>Manage your invoice registry integration</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">01</div>
                        <div class="stat-info">
                            <span class="stat-value" id="daily-limit">1,000</span>
                            <span class="stat-label">Daily Limit</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">02</div>
                        <div class="stat-info">
                            <span class="stat-value" id="monthly-limit">20,000</span>
                            <span class="stat-label">Monthly Limit</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">03</div>
                        <div class="stat-info">
                            <span class="stat-value" id="tracking-status">Enabled</span>
                            <span class="stat-label">Funder Tracking</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">04</div>
                        <div class="stat-info">
                            <span class="stat-value">Active</span>
                            <span class="stat-label">Account Status</span>
                        </div>
                    </div>
                </div>

                <div class="quick-start">
                    <h2>Quick Start</h2>
                    <div class="code-block">
                        <div class="code-header">
                            <span>Check if invoice is funded</span>
                            <button class="copy-btn" onclick="copyCode('check-code')">Copy</button>
                        </div>
                        <pre id="check-code">curl -X POST <span class="api-url"></span>/api/v1/invoices/check-raw \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "document_type": "INV",
    "document_id": "INV-2024-001",
    "supplier_tax_id": "123456789",
    "supplier_country": "DE",
    "buyer_tax_id": "987654321",
    "buyer_country": "AT",
    "amount": 10000.00,
    "currency": "EUR"
  }'</pre>
                    </div>
                </div>
            </section>

            <!-- Invoices Section -->
            <section id="section-invoices" class="dashboard-section">
                <div class="section-header">
                    <h1>Invoice Management</h1>
                    <p>Check and register invoices manually</p>
                </div>

                <div class="data-rules-notice">
                    <div class="notice-icon">!</div>
                    <div class="notice-content">
                        <strong>Enter data exactly as it appears on the invoice</strong>
                        <p>Even a single character difference will produce a different hash and fail to match. See the <a href="/#data-rules">Data Entry Rules</a> for detailed formatting guidelines.</p>
                    </div>
                </div>

                <div class="invoice-grid">
                    <!-- Check Invoice Card -->
                    <div class="card">
                        <h3>Check Invoice</h3>
                        <p class="text-muted">Verify if an invoice is already funded</p>
                        <form id="check-invoice-form" onsubmit="checkInvoice(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-document-id">Document ID <span class="required">*</span></label>
                                    <input type="text" id="check-document-id" required placeholder="INV-2024-001">
                                    <span class="field-hint">Exactly as printed, including hyphens and prefixes</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-document-type">Type</label>
                                    <select id="check-document-type">
                                        <option value="INV" selected>Invoice</option>
                                        <option value="CN">Credit Note</option>
                                        <option value="DN">Debit Note</option>
                                        <option value="PO">Purchase Order</option>
                                    </select>
                                    <span class="field-hint">Document type</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-supplier-tax-id">Supplier Tax ID <span class="required">*</span></label>
                                    <input type="text" id="check-supplier-tax-id" required placeholder="123456789">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-supplier-country">Country <span class="required">*</span></label>
                                    <input type="text" id="check-supplier-country" required placeholder="DE" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-buyer-tax-id">Buyer Tax ID <span class="required">*</span></label>
                                    <input type="text" id="check-buyer-tax-id" required placeholder="987654321">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-buyer-country">Country <span class="required">*</span></label>
                                    <input type="text" id="check-buyer-country" required placeholder="AT" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="check-amount">Amount</label>
                                    <input type="number" id="check-amount" step="0.01" placeholder="10000.00">
                                    <span class="field-hint">Gross total with decimal point</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="check-currency">Currency</label>
                                    <input type="text" id="check-currency" placeholder="EUR" maxlength="3" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="hash-level-info">
                                <span class="level-indicator">L0-L3</span> Checks party (L0), relationship (L1), document (L2), and full (L3) levels
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Check Invoice</button>
                        </form>
                        <div id="check-result" class="result-box"></div>
                    </div>

                    <!-- Register Invoice Card -->
                    <div class="card">
                        <h3>Register Invoice</h3>
                        <p class="text-muted">Register an invoice as funded</p>
                        <form id="register-invoice-form" onsubmit="registerInvoice(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-document-id">Document ID <span class="required">*</span></label>
                                    <input type="text" id="reg-document-id" required placeholder="INV-2024-001">
                                    <span class="field-hint">Exactly as printed, including hyphens and prefixes</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-document-type">Type</label>
                                    <select id="reg-document-type">
                                        <option value="INV" selected>Invoice</option>
                                        <option value="CN">Credit Note</option>
                                        <option value="DN">Debit Note</option>
                                        <option value="PO">Purchase Order</option>
                                    </select>
                                    <span class="field-hint">Document type</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-supplier-tax-id">Supplier Tax ID <span class="required">*</span></label>
                                    <input type="text" id="reg-supplier-tax-id" required placeholder="123456789">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-supplier-country">Country <span class="required">*</span></label>
                                    <input type="text" id="reg-supplier-country" required placeholder="DE" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-buyer-tax-id">Buyer Tax ID <span class="required">*</span></label>
                                    <input type="text" id="reg-buyer-tax-id" required placeholder="987654321">
                                    <span class="field-hint">Numbers only, no country prefix</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-buyer-country">Country <span class="required">*</span></label>
                                    <input type="text" id="reg-buyer-country" required placeholder="AT" maxlength="2" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reg-amount">Amount</label>
                                    <input type="number" id="reg-amount" step="0.01" placeholder="10000.00">
                                    <span class="field-hint">Gross total with decimal point</span>
                                </div>
                                <div class="form-group form-group-small">
                                    <label for="reg-currency">Currency</label>
                                    <input type="text" id="reg-currency" placeholder="EUR" maxlength="3" style="text-transform: uppercase;">
                                    <span class="field-hint">ISO code</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="reg-expires">Expires In (days)</label>
                                <input type="number" id="reg-expires" placeholder="730" value="730">
                                <span class="field-hint">How long before registration auto-expires (default: 2 years)</span>
                            </div>
                            <div class="hash-level-info">
                                <span class="level-indicator">L1-L3</span> Registers relationship (L1), document (L2), and optionally full (L3) levels
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Register Invoice</button>
                        </form>
                        <div id="register-result" class="result-box"></div>
                    </div>
                </div>
            </section>

            <!-- API Keys Section -->
            <section id="section-api-keys" class="dashboard-section">
                <div class="section-header">
                    <h1>API Keys</h1>
                    <p>Manage your API credentials</p>
                </div>

                <div class="card">
                    <h3>Current API Key</h3>
                    <p class="text-muted">Use this key in the X-API-Key header</p>
                    <div class="api-key-display">
                        <code id="current-api-key">Loading...</code>
                        <button class="btn btn-ghost" onclick="copyApiKey()">Copy</button>
                    </div>
                    <button class="btn btn-danger" onclick="regenerateApiKey()">
                        Regenerate API Key
                    </button>
                    <p class="warning-text">Regenerating will invalidate your current key immediately.</p>
                </div>

                <div class="card">
                    <h3>OAuth 2.0 Credentials</h3>
                    <p class="text-muted">For enterprise integrations using OAuth client credentials flow</p>
                    <div class="oauth-info">
                        <div class="form-group">
                            <label>Client ID</label>
                            <code id="oauth-client-id-display">Available at signup only</code>
                        </div>
                        <p class="info-text">OAuth credentials are only shown during account creation. Contact support if you need new OAuth credentials.</p>
                    </div>
                </div>
            </section>

            <!-- Test API Section -->
            <section id="section-test-api" class="dashboard-section">
                <div class="section-header">
                    <h1>Test API</h1>
                    <p>Try out the API with sample requests</p>
                </div>

                <div class="card">
                    <h3>Check Invoice Status</h3>
                    <p class="text-muted">Test the API with a sample invoice check</p>
                    <button class="btn btn-primary" onclick="testCheckInvoice()">
                        Run Test Check
                    </button>
                    <div id="test-result" class="test-result"></div>
                </div>

                <div class="card">
                    <h3>API Endpoints</h3>
                    <table class="endpoints-table">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Endpoint</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="endpoint-group">Invoice Endpoints</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/check</code></td>
                                <td>Check with pre-hashed data</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/check-raw</code></td>
                                <td>Check with raw invoice data (L0-L3)</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/register</code></td>
                                <td>Register with pre-hashed data</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/invoices/register-raw</code></td>
                                <td>Register with raw invoice data</td>
                            </tr>
                            <tr>
                                <td><span class="method delete">DELETE</span></td>
                                <td><code>/api/v1/invoices/{hash}</code></td>
                                <td>Unregister an invoice</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="endpoint-group">Party Endpoints (L0)</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/party/check</code></td>
                                <td>Check buyer/supplier existence</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/party/register</code></td>
                                <td>Register a party</td>
                            </tr>
                            <tr>
                                <td><span class="method post">POST</span></td>
                                <td><code>/api/v1/party/history</code></td>
                                <td>Query party check history</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="endpoint-group">Reference Data</td>
                            </tr>
                            <tr>
                                <td><span class="method get">GET</span></td>
                                <td><code>/api/v1/document-types</code></td>
                                <td>List available document types</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Documentation Section -->
            <section id="section-docs" class="dashboard-section">
                <div class="section-header">
                    <h1>Documentation</h1>
                    <p>Learn how to integrate RegStrava</p>
                </div>

                <div class="docs-grid">
                    <div class="card">
                        <h3>Quick Start</h3>
                        <p>Get up and running in minutes with our step-by-step guide.</p>
                        <a href="https://github.com/janovincze/RegStrava#quick-start" target="_blank" class="btn btn-ghost">View Guide</a>
                    </div>
                    <div class="card">
                        <h3>API Reference</h3>
                        <p>Complete API documentation with examples.</p>
                        <a href="https://github.com/janovincze/RegStrava#api-usage" target="_blank" class="btn btn-ghost">View Docs</a>
                    </div>
                    <div class="card">
                        <h3>Go SDK</h3>
                        <p>Official Go SDK for client-side hashing.</p>
                        <a href="https://github.com/janovincze/RegStrava#go-sdk" target="_blank" class="btn btn-ghost">View SDK</a>
                    </div>
                    <div class="card">
                        <h3>Security</h3>
                        <p>Learn about our privacy-preserving approach.</p>
                        <a href="https://github.com/janovincze/RegStrava#security" target="_blank" class="btn btn-ghost">Learn More</a>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="dashboard-section">
                <div class="section-header">
                    <h1>Settings</h1>
                    <p>Manage your account settings</p>
                </div>

                <div class="card">
                    <h3>Profile Information</h3>
                    <form id="profile-form" onsubmit="updateProfile(event)">
                        <div class="form-group">
                            <label for="profile-name">Name</label>
                            <input type="text" id="profile-name" name="name">
                        </div>
                        <div class="form-group">
                            <label>Funder ID</label>
                            <code id="funder-id">Loading...</code>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Funder Tracking</h3>
                    <p class="text-muted">Allow tracking of your funding registrations for audit purposes.</p>
                    <div class="toggle-group">
                        <label class="toggle">
                            <input type="checkbox" id="tracking-toggle" onchange="updateTracking()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span>Enable funder tracking</span>
                    </div>
                </div>

                <div class="card danger-zone">
                    <h3>Danger Zone</h3>
                    <p class="text-muted">Irreversible actions</p>
                    <button class="btn btn-danger" onclick="logout()">
                        Logout from all devices
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Set API URL in examples
            document.querySelectorAll('.api-url').forEach(el => {
                el.textContent = window.location.origin;
            });

            // Load funder name from storage
            const funderName = localStorage.getItem('regstrava_funder_name');
            if (funderName) {
                document.getElementById('nav-funder-name').textContent = funderName;
            }

            // Load API key preview
            const apiKey = localStorage.getItem('regstrava_api_key');
            if (apiKey) {
                document.getElementById('current-api-key').textContent = apiKey.substring(0, 20) + '...';
            }

            // Load dashboard data
            loadDashboard();
        });

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active from all links
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById('section-' + sectionId).classList.add('active');

            // Mark link as active
            event.target.closest('.sidebar-link').classList.add('active');
        }

        function copyCode(elementId) {
            const code = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(code);
        }

        function copyApiKey() {
            const apiKey = localStorage.getItem('regstrava_api_key');
            navigator.clipboard.writeText(apiKey).then(() => {
                alert('API Key copied to clipboard!');
            });
        }

        async function updateProfile(e) {
            e.preventDefault();
            const apiKey = localStorage.getItem('regstrava_api_key');
            const name = document.getElementById('profile-name').value;

            try {
                const response = await fetch('/api/v1/funders/me', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    localStorage.setItem('regstrava_funder_name', name);
                    document.getElementById('funder-name').textContent = name;
                    document.getElementById('nav-funder-name').textContent = name;
                    alert('Profile updated!');
                }
            } catch (error) {
                alert('Error updating profile');
            }
        }

        async function updateTracking() {
            const apiKey = localStorage.getItem('regstrava_api_key');
            const tracking = document.getElementById('tracking-toggle').checked;

            try {
                await fetch('/api/v1/funders/me', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ track_fundings: tracking })
                });
            } catch (error) {
                alert('Error updating tracking settings');
            }
        }

        // Check Invoice
        async function checkInvoice(e) {
            e.preventDefault();
            const apiKey = localStorage.getItem('regstrava_api_key');
            const resultDiv = document.getElementById('check-result');

            const data = {
                document_type: document.getElementById('check-document-type').value,
                document_id: document.getElementById('check-document-id').value,
                supplier_tax_id: document.getElementById('check-supplier-tax-id').value,
                supplier_country: document.getElementById('check-supplier-country').value.toUpperCase(),
                buyer_tax_id: document.getElementById('check-buyer-tax-id').value,
                buyer_country: document.getElementById('check-buyer-country').value.toUpperCase()
            };

            const amount = document.getElementById('check-amount').value;
            if (amount) data.amount = parseFloat(amount);

            const currency = document.getElementById('check-currency').value;
            if (currency) data.currency = currency.toUpperCase();

            resultDiv.innerHTML = '<div class="loading">Checking...</div>';

            try {
                const response = await fetch('/api/v1/invoices/check-raw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.found) {
                        const levels = result.matched_levels ? result.matched_levels.join(', ') : 'N/A';
                        let detailsHtml = '';
                        if (result.details) {
                            detailsHtml = Object.entries(result.details).map(([level, detail]) =>
                                `<div><span class="label">${level}:</span> ${detail.status} (${new Date(detail.first_seen).toLocaleDateString()})</div>`
                            ).join('');
                        }
                        resultDiv.innerHTML = `
                            <div class="result-funded">
                                <div class="result-icon">&#10007;</div>
                                <div class="result-title">Match Found</div>
                                <div class="result-detail">
                                    <span class="label">Matched Levels:</span> ${levels}<br>
                                    ${detailsHtml}
                                </div>
                            </div>`;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="result-clear">
                                <div class="result-icon">&#10003;</div>
                                <div class="result-title">Not Found</div>
                                <div class="result-detail">This invoice is not in the registry. Safe to fund.</div>
                            </div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="result-error">Error: ${result.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result-error">Error: ${error.message}</div>`;
            }
        }

        // Register Invoice
        async function registerInvoice(e) {
            e.preventDefault();
            const apiKey = localStorage.getItem('regstrava_api_key');
            const resultDiv = document.getElementById('register-result');

            const data = {
                document_type: document.getElementById('reg-document-type').value,
                document_id: document.getElementById('reg-document-id').value,
                supplier_tax_id: document.getElementById('reg-supplier-tax-id').value,
                supplier_country: document.getElementById('reg-supplier-country').value.toUpperCase(),
                buyer_tax_id: document.getElementById('reg-buyer-tax-id').value,
                buyer_country: document.getElementById('reg-buyer-country').value.toUpperCase(),
                funding_date: new Date().toISOString().split('T')[0]
            };

            const amount = document.getElementById('reg-amount').value;
            if (amount) data.amount = parseFloat(amount);

            const currency = document.getElementById('reg-currency').value;
            if (currency) data.currency = currency.toUpperCase();

            const expires = document.getElementById('reg-expires').value;
            if (expires) data.expires_in_days = parseInt(expires);

            resultDiv.innerHTML = '<div class="loading">Registering...</div>';

            try {
                const response = await fetch('/api/v1/invoices/register-raw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    const levels = result.hash_levels ? result.hash_levels.map(l => 'L' + l).join(', ') : 'N/A';
                    resultDiv.innerHTML = `
                        <div class="result-success">
                            <div class="result-icon">&#10003;</div>
                            <div class="result-title">Invoice Registered</div>
                            <div class="result-detail">
                                <span class="label">Hash Levels:</span> ${levels}<br>
                                <span class="label">Registered At:</span> ${new Date(result.registered_at).toLocaleDateString()}
                            </div>
                        </div>`;
                    // Clear form
                    document.getElementById('register-invoice-form').reset();
                    document.getElementById('reg-expires').value = '730';
                } else {
                    resultDiv.innerHTML = `<div class="result-error">Error: ${result.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result-error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
